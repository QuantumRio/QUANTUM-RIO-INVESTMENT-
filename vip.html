<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>VIP Plans | Quantum Rio Uganda</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
<style>
  body {font-family:'Segoe UI',sans-serif;background:#001f3f;margin:0;padding:0 0 0.5cm 0;color:#fff;}
  header {background:#002f6c;text-align:center;padding:20px;color:#fff;display:flex;align-items:center;justify-content:center;gap:10px;}
  header img{height:32px;}
  .container{padding:20px;}
  .intro{background:rgba(255,255,255,0.05);padding:15px;border-radius:10px;margin-bottom:20px;}
  .plans{display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:20px;}
  .plan-card{background:rgba(255,255,255,0.05);border-radius:10px;padding:20px;box-shadow:0 4px 12px rgba(0,0,0,0.1);}
  .plan-card h3{margin:0 0 6px;color:#ffd966;}
  .plan-card p{font-size:14px;color:#cfe6ff;margin:4px 0;}
  .plan-card button{margin-top:10px;padding:10px;width:100%;background:#ffcc00;color:#002244;border:none;border-radius:6px;font-weight:bold;cursor:pointer;}
  .plan-card button:disabled{background:#666;cursor:not-allowed;}
  .popup{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:#28a745;color:#fff;padding:15px 30px;border-radius:8px;display:none;z-index:999;font-weight:bold;font-size:14px;box-shadow:0 4px 15px rgba(0,0,0,0.3);text-align:center;}
  .popup.red{background:#cc0000;}
  nav{position:fixed;bottom:0;left:0;right:0;display:flex;justify-content:space-around;background:#002244;padding:8px 0;}
  nav a{color:#fff;text-decoration:none;text-align:center;font-size:0.8rem;}
  nav i{font-size:18px;}
</style>
</head>
<body>

<header>
  <img src="https://png.pngtree.com/png-clipart/20221216/original/pngtree-vip-icon-design-png-image_8749175.png" alt="logo">
  <h2>QUANTUM RIO – VIP Plans</h2>
</header>

<div class="container">
  <div class="intro">
    <p>Welcome! Invest today in your VIP plan and watch your returns grow.</p>
    <p>Current Balance: <span id="userBalance">0</span> UGX</p>
  </div>
  <div class="plans" id="plansContainer"></div>
</div>

<div class="popup" id="popupMsg"></div>

<nav>
  <a href="dashboard.html"><i class="fas fa-home"></i><br>Home</a>
  <a href="task.html"><i class="fas fa-tasks"></i><br>Task</a>
  <a href="team.html"><i class="fas fa-users"></i><br>Team</a>
  <a href="vip.html"><i class="fas fa-crown"></i><br>VIP</a>
  <a href="profile.html"><i class="fas fa-user"></i><br>Me</a>
</nav>

<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-compat.js"></script>
<script>
const firebaseConfig = {
  apiKey: "AIzaSyC6jW448tW3e8m6XVGjOegT8IGJQJERweY",
  authDomain: "quantum-rio-uganda.firebaseapp.com",
  databaseURL: "https://quantum-rio-uganda-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "quantum-rio-uganda",
  storageBucket: "quantum-rio-uganda.appspot.com",
  messagingSenderId: "840875099079",
  appId: "1:840875099079:web:1cd06a78276842a787cfe2",
  measurementId: "G-97G1PNQ9JB"
};
firebase.initializeApp(firebaseConfig);
const auth=firebase.auth();
const db=firebase.database();

// Plans: [amount, roi, name]
const plans=[
  [75000,150000,"Starter Plan"],
  [105000,210000,"Bronze Plan"],
  [150000,300000,"Silver Plan"],
  [200000,400000,"Gold Plan"],
  [250000,500000,"Platinum Plan"],
  [300000,600000,"Diamond Plan"],
  [350000,700000,"Ruby Plan"],
  [400000,800000,"Emerald Plan"],
  [450000,900000,"Sapphire Plan"],
  [500000,1000000,"Elite Plan"]
];

let currentBalance=0;
let activeInvestments={};
let countdownIntervals={};

auth.onAuthStateChanged(user=>{
  if(!user){window.location='signin.html';return;}
  const uid=user.uid;

  const balRef=db.ref('users/'+uid+'/balance');
  balRef.on('value',snap=>{
    currentBalance=snap.val()||0;
    document.getElementById('userBalance').textContent=
      currentBalance.toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2});
  });

  db.ref('investments/'+uid).on('value',snap=>{
    activeInvestments={};
    snap.forEach(child=>{
      const inv=child.val();
      if(inv.status==="active"){
        activeInvestments[inv.investedAmount]={...inv,key:child.key};
      }
    });
    loadPlans(uid);
  });
});

function loadPlans(uid){
  const container = document.getElementById('plansContainer');
  container.innerHTML='';
  plans.forEach(([amount, roi, name])=>{
    const div = document.createElement('div');
    div.className='plan-card';
    const btn = document.createElement('button');
    btn.textContent = "Invest Now";
    btn.onclick = ()=>invest(amount, roi, uid, name, btn);

    div.innerHTML=`
      <h3>${name}</h3>
      <p>Invest: ${amount.toLocaleString()} UGX</p>
      <p>Income: ${roi.toLocaleString()} UGX (credited in 24 hrs)</p>
    `;
    div.appendChild(btn);
    container.appendChild(div);
  });

  // ✅ Highlight already unlocked levels
  db.ref('users/'+uid+'/vipLevels').on('value', snap=>{
    const unlocked = snap.val() || {};
    document.querySelectorAll('.plan-card').forEach(card=>{
      const planName = card.querySelector('h3').innerText;
      if(unlocked[planName]){
        const btn = card.querySelector('button');
        btn.disabled = true;
        btn.textContent = "Invested ✔";
        card.style.border = "2px solid #28a745"; // highlight
      }
    });
  });
      }

function invest(amount, roi, uid, planName){
  if(currentBalance < amount){
    showPopup("❌ Insufficient balance", true);
    return;
  }

  const userRef = db.ref('users/'+uid);
  userRef.transaction(userData=>{
    if(!userData) userData={};
    const current = parseFloat(userData.balance||0);
    if(current < amount) return userData;
    userData.balance = current - amount;
    if(!userData.vipLevels) userData.vipLevels = {};
    userData.vipLevels[planName] = true; // ✅ unlock level
    return userData;
  },(err, committed)=>{
    if(err || !committed){ showPopup("❌ Transaction failed", true); return; }

    db.ref('investments/'+uid).push({
      investedAmount: amount,
      returnAmount: roi,
      investedAt: Date.now(),
      status: "active",
      planName: planName
    });

    showPopup(`✅ Invested ${amount.toLocaleString()} UGX`);
  });
}

function creditAndUnlock(uid,key,inv,vipLevel){
  const userRef=db.ref('users/'+uid+'/balance');
  userRef.transaction(bal=>(bal||0)+inv.returnAmount);
  db.ref('investments/'+uid+'/'+key+'/status').set("completed");
  delete activeInvestments[inv.investedAmount];
  loadPlans(uid);
  // keep VIP unlocked
  db.ref('users/'+uid+'/vipLevels/'+vipLevel).set(true);
}

function updateCountdown(button,investedAt,uid,key,roi,amount,planRoi,vipLevel){
  const now=Date.now();
  const diff=24*60*60*1000-(now-investedAt);
  if(diff<=0){
    clearInterval(countdownIntervals[amount]);
    creditAndUnlock(uid,key,{investedAmount:amount,returnAmount:roi},vipLevel);
    return;
  }
  const h=Math.floor(diff/(1000*60*60));
  const m=Math.floor((diff%(1000*60*60))/(1000*60));
  const s=Math.floor((diff%(1000*60))/1000);
  button.textContent=`${h}h ${m}m ${s}s left`;
}

function showPopup(msg,red=false){
  const p=document.getElementById('popupMsg');
  p.innerText=msg;
  p.className='popup'+(red?' red':'');
  p.style.display='block';
  setTimeout(()=>p.style.display='none',4000);
}
</script>
</body>
</html>

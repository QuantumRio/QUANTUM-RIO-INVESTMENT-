<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>VIP Plans | Quantum Rio Uganda</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
<style>
  body {
    font-family: 'Segoe UI', sans-serif;
    background-color: #001f3f;
    margin: 0;
    padding: 0 0 0.5cm 0;
    color: #fff;
  }
  header {
    background-color: #002f6c;
    text-align: center;
    padding: 20px;
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
  }
  header img { height:32px; }
  .container { padding: 20px; }
  .intro {
    background: rgba(255,255,255,0.05);
    padding: 15px;
    border-radius: 10px;
    margin-bottom: 20px;
  }
  .plans {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 20px;
  }
  .plan-card {
    background: rgba(255,255,255,0.05);
    border-radius: 10px;
    padding: 20px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
  }
  .plan-card h3 { margin: 0 0 6px 0; color: #ffd966; }
  .plan-card p { font-size: 14px; color: #cfe6ff; margin: 4px 0; }
  .plan-card button {
    margin-top: 10px;
    padding: 10px;
    width: 100%;
    border: none;
    border-radius: 6px;
    font-weight: bold;
    cursor: pointer;
  }
  .plan-card button.invest { background-color: #ffcc00; color: #002244; }
  .plan-card button.disabled { background: #555; color: #ccc; cursor: not-allowed; }
  .plan-card button.receive { background: #28a745; color: #fff; }
  .plan-card button.completed { background: #444; color: #0f0; cursor: not-allowed; }
  .popup {
    position: fixed;
    top: 50%; left: 50%;
    transform: translate(-50%, -50%);
    background: #28a745;
    color: white;
    padding: 15px 30px;
    border-radius: 8px;
    display: none;
    z-index: 999;
    font-weight: bold;
    font-size: 14px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.3);
    text-align: center;
  }
  .popup.red{background:#cc0000;}
  nav{
    position:fixed;bottom:0;left:0;right:0;
    display:flex;justify-content:space-around;
    background:#002244;padding:8px 0;
  }
  nav a{color:#fff;text-decoration:none;text-align:center;font-size:0.8rem;}
  nav i{font-size:18px;}
</style>
</head>
<body>

<header>
  <img src="https://png.pngtree.com/png-clipart/20221216/original/pngtree-vip-icon-design-png-image_8749175.png" alt="logo">
  <h2>QUANTUM RIO ‚Äì VIP Plans</h2>
</header>

<div class="container">
  <div class="intro">
    <p>Welcome! Invest today in your VIP plan and watch your returns grow.</p>
    <p>Current Balance: <span id="userBalance">0</span> UGX</p>
  </div>
  <div class="plans" id="plansContainer"></div>
</div>

<div class="popup" id="popupMsg"></div>

<nav>
  <a href="dashboard.html"><i class="fas fa-home"></i><br>Home</a>
  <a href="task.html"><i class="fas fa-tasks"></i><br>Task</a>
  <a href="team.html"><i class="fas fa-users"></i><br>Team</a>
  <a href="vip.html"><i class="fas fa-crown"></i><br>VIP</a>
  <a href="profile.html"><i class="fas fa-user"></i><br>Me</a>
</nav>

<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-compat.js"></script>
<script>
const firebaseConfig = {
  apiKey: "AIzaSyC6jW448tW3e8m6XVGjOegT8IGJQJERweY",
  authDomain: "quantum-rio-uganda.firebaseapp.com",
  databaseURL: "https://quantum-rio-uganda-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "quantum-rio-uganda",
  storageBucket: "quantum-rio-uganda.appspot.com",
  messagingSenderId: "840875099079",
  appId: "1:840875099079:web:1cd06a78276842a787cfe2",
  measurementId: "G-97G1PNQ9JB"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.database();

// Plans: [amount, roi, name]
const plans = [
  [75000,150000,"Starter Plan"],
  [105000,210000,"Bronze Plan"],
  [150000,300000,"Silver Plan"],
  [200000,400000,"Gold Plan"],
  [250000,500000,"Platinum Plan"],
  [300000,600000,"Diamond Plan"],
  [350000,700000,"Ruby Plan"],
  [400000,800000,"Emerald Plan"],
  [450000,900000,"Sapphire Plan"],
  [500000,1000000,"Elite Plan"]
];

let currentBalance = 0;
let activeInvestments = {};   // { amount: {investedAt, returnAmount, key} }
let unlockedVips = {};        // { amount: true }
let countdownIntervals = {};  // { amount: intervalId }

auth.onAuthStateChanged(user=>{
  if(!user){ window.location='signin.html'; return; }
  const uid = user.uid;

  // balance listener
  db.ref('users/'+uid+'/balance').on('value', snap=>{
    currentBalance = snap.val() || 0;
    document.getElementById('userBalance').textContent =
      currentBalance.toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2});
  });

  // unlocked VIPs (completed) listener
  db.ref('users/'+uid+'/unlockedVips').on('value', snap=>{
    unlockedVips = snap.val() || {};
    loadPlans(uid);
  });

  // investments listener
  db.ref('investments/'+uid).on('value', snap=>{
    activeInvestments = {};
    snap.forEach(child=>{
      const inv = child.val();
      const key = child.key;
      if(!inv) return;
      // only treat active investments as active; completed ones are handled via unlockedVips
      if(inv.status === "active"){
        // keep investment in active map (we will check elapsed time when rendering)
        activeInvestments[inv.investedAmount] = { ...inv, key };
      }
    });
    loadPlans(uid);
  });
});

// build UI
function loadPlans(uid){
  const container = document.getElementById('plansContainer');
  container.innerHTML = '';
  // clear existing countdown intervals
  Object.values(countdownIntervals).forEach(id => clearInterval(id));
  countdownIntervals = {};

  plans.forEach(([amount, roi, name])=>{
    const div = document.createElement('div');
    div.className = 'plan-card';

    const header = document.createElement('div');
    header.innerHTML = `<h3>${name}</h3>
                        <p>Invest: ${amount.toLocaleString()} UGX</p>
                        <p>Income: ${roi.toLocaleString()} UGX (receive after 24 hrs)</p>`;
    div.appendChild(header);

    const btn = document.createElement('button');

    const active = activeInvestments[amount];
    const completed = Boolean(unlockedVips && unlockedVips[amount]);

    if(completed){
      btn.textContent = "‚úÖ Completed";
      btn.className = "completed";
      btn.disabled = true;
    } else if(active){
      // check elapsed time
      const investedAt = Number(active.investedAt) || 0;
      const elapsed = Date.now() - investedAt;
      const dayMs = 24*60*60*1000;

      if(elapsed >= dayMs){
        // 24+ hours passed ‚Äî show enabled Receive (user must click to claim)
        btn.textContent = "Receive";
        btn.className = "receive";
        btn.disabled = false;
        btn.addEventListener('click', ()=> receiveProfits(uid, active.key, active));
      } else {
        // still within 24 hours ‚Äî disabled countdown button
        btn.className = "disabled";
        btn.disabled = true;
        // initial label
        btn.textContent = formatRemaining(investedAt);
        // set interval to update label and enable button when time is up
        countdownIntervals[amount] = setInterval(()=>{
          const nowElapsed = Date.now() - investedAt;
          if(nowElapsed >= dayMs){
            clearInterval(countdownIntervals[amount]);
            delete countdownIntervals[amount];
            // enable receive button (user must click to claim)
            btn.textContent = "Receive";
            btn.className = "receive";
            btn.disabled = false;
            // replace listeners: ensure only one listener
            btn.replaceWith(btn.cloneNode(true));
            const newBtn = div.querySelector('button');
            newBtn.addEventListener('click', ()=> receiveProfits(uid, active.key, active));
          } else {
            btn.textContent = formatRemaining(investedAt);
          }
        }, 1000);
      }
    } else {
      // no active investment and not completed => allow invest
      btn.textContent = "Invest Now";
      btn.className = "invest";
      btn.disabled = false;
      btn.addEventListener('click', ()=> invest(amount, roi, uid));
    }

    div.appendChild(btn);
    container.appendChild(div);
  });
}

function formatRemaining(investedAt){
  const dayMs = 24*60*60*1000;
  const diff = dayMs - (Date.now() - investedAt);
  if(diff <= 0) return "Receive";
  const hours = Math.floor(diff / (1000*60*60));
  const mins = Math.floor((diff % (1000*60*60)) / (1000*60));
  const secs = Math.floor((diff % (1000*60)) / 1000);
  return `Receive in ${hours}h ${mins}m ${secs}s`;
}

// invest: deduct balance (transaction), push investment, update local cache immediately
function invest(amount, roi, uid){
  if(currentBalance < amount){
    showPopup("‚ùå Insufficient balance", true);
    return;
  }

  const userRef = db.ref('users/'+uid);
  userRef.transaction(userData=>{
    if(!userData) userData={};
    const current = parseFloat(userData.balance || 0);
    if(current < amount) return userData;
    userData.balance = current - amount;
    return userData;
  }, (err, committed, snapshot) => {
    if(err || !committed){
      showPopup("‚ùå Transaction failed", true);
      return;
    }

    const newInvRef = db.ref('investments/'+uid).push();
    const newInvestment = {
      investedAmount: amount,
      returnAmount: roi,
      investedAt: Date.now(),
      status: "active"
    };
    newInvRef.set(newInvestment)
      .then(()=>{
        // immediate UI update: mark as active so button disables right away
        activeInvestments[amount] = { ...newInvestment, key: newInvRef.key };
        loadPlans(uid);
        showPopup(`‚úÖ Invested ${amount.toLocaleString()} UGX`);
      })
      .catch(()=> {
        showPopup("‚ùå Could not record investment", true);
      });
  });
}

// receive profits: user clicks Receive (only after 24hrs). This credits + marks completed + unlocks
function receiveProfits(uid, key, inv){
  if(!inv || !key) return;
  // double-check that 24h elapsed (prevent early click)
  const investedAt = Number(inv.investedAt) || 0;
  const dayMs = 24*60*60*1000;
  if(Date.now() - investedAt < dayMs){
    showPopup("‚è≥ Not ready yet", true);
    // refresh UI to reflect true state
    loadPlans(uid);
    return;
  }

  const balRef = db.ref('users/'+uid+'/balance');
  balRef.transaction(bal => (bal || 0) + inv.returnAmount, (err, committed) => {
    // mark investment completed and persist unlocked state
    db.ref('investments/'+uid+'/'+key+'/status').set("completed").catch(()=>{});
    db.ref('users/'+uid+'/unlockedVips/'+inv.investedAmount).set(true).catch(()=>{});

    // update local caches and UI
    delete activeInvestments[inv.investedAmount];
    unlockedVips[inv.investedAmount] = true;
    loadPlans(uid);

    showPopup(`üí∞ Received ${inv.returnAmount.toLocaleString()} UGX`);
  });
}

function showPopup(msg, red=false){
  const popup = document.getElementById('popupMsg');
  popup.innerText = msg;
  popup.className = 'popup' + (red ? ' red' : '');
  popup.style.display = 'block';
  setTimeout(()=> popup.style.display = 'none', 3500);
}
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sign Up â€“ QUAANTUM RIO INVESTMENT</title>
<style>
  /* all your original CSS exactly as posted â€¦ */
</style>
</head>
<body>
<div class="card">
  <div class="brand">
    <h1>QUAANTUM RIO INVESTMENT</h1>
    <span>Secure â€¢ Reliable â€¢ Growth</span>
  </div>

  <div id="refBanner" class="ref-banner"></div>

  <label for="username">Username</label>
  <input type="text" id="username" placeholder="Choose a username" required>

  <label for="phone">Phone Number</label>
  <div class="phone-row">
    <div class="phone-code"><span>ðŸ‡ºðŸ‡¬</span> +256</div>
    <input type="tel" id="phone" class="phone-number" placeholder="784514172" required>
  </div>

  <label for="email">Email</label>
  <input type="email" id="email" placeholder="Enter your email" required>

  <label for="password">Password</label>
  <input type="password" id="password" placeholder="Minimum 6 characters" required>

  <label for="confirmPassword">Confirm Password</label>
  <input type="password" id="confirmPassword" placeholder="Repeat password" required>

  <button id="signupBtn">Create Account</button>

  <div class="links">
    Already have an account? <a href="signin.html">Sign In</a><br>
    <a href="forgot.html">Forgot Password?</a>
  </div>
</div>

<div id="toast" class="toast"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.1/firebase-app.js";
import { getAuth, createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.11.1/firebase-auth.js";
import {
  getDatabase, ref, set, get, query, orderByChild, equalTo, runTransaction
} from "https://www.gstatic.com/firebasejs/10.11.1/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyC6jW448tW3e8m6XVGjOegT8IGJQJERweY",
  authDomain: "quantum-rio-uganda.firebaseapp.com",
  databaseURL: "https://quantum-rio-uganda-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "quantum-rio-uganda",
  storageBucket: "quantum-rio-uganda.appspot.com",
  messagingSenderId: "840875099079",
  appId: "1:840875099079:web:1cd06a78276842a787cfe2",
  measurementId: "G-97G1PNQ9JB"
};
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getDatabase(app);

function toast(msg, type="error", delay=3000){
  const el = document.getElementById("toast");
  el.textContent = msg;
  el.className = "toast " + type + " show";
  setTimeout(()=>el.className="toast " + type, delay);
}

// ?ref=username
let referrer = null;
const params = new URLSearchParams(location.search);
if (params.has("ref")){
  referrer = params.get("ref");
  const banner = document.getElementById("refBanner");
  banner.textContent = "You were referred by " + referrer;
  banner.style.display = "block";
}

document.getElementById("signupBtn").addEventListener("click", async ()=>{
  const username = document.getElementById("username").value.trim();
  const phone    = document.getElementById("phone").value.trim();
  const email    = document.getElementById("email").value.trim();
  const password = document.getElementById("password").value;
  const confirm  = document.getElementById("confirmPassword").value;

  if(!username || !phone || !email || !password || !confirm)
    return toast("Please fill all fields.");
  if(password.length < 6) return toast("Password must be at least 6 characters.");
  if(password !== confirm) return toast("Passwords do not match.");

  try {
    const snapU = await get(query(ref(db,"users"), orderByChild("username"), equalTo(username)));
    if (snapU.exists()) return toast("Username already taken.");
    const snapP = await get(query(ref(db,"users"), orderByChild("phone"), equalTo(phone)));
    if (snapP.exists()) return toast("Phone already registered.");
    const snapE = await get(query(ref(db,"users"), orderByChild("email"), equalTo(email)));
    if (snapE.exists()) return toast("Email already registered.");

    const cred = await createUserWithEmailAndPassword(auth, email, password);
    const uid  = cred.user.uid;

    // <-- changed here: save referral under "referrer" -->
    await set(ref(db, "users/" + uid), {
      uid, username, phone, email,
      referrer: referrer || null,
      joinedAt: Date.now(),
      balance: 0,
      earnings: 0,
      referralsCount: 0,
      vipLevels: { level1:false, level2:false, level3:false, level4:false, level5:false }
    });

    if(referrer){
      const inviterSnap = await get(query(ref(db, "users"), orderByChild("username"), equalTo(referrer)));
      if (inviterSnap.exists()){
        inviterSnap.forEach(c=>{
          runTransaction(ref(db, "users/" + c.key + "/referralsCount"), cur => (cur||0)+1);
        });
      }
    }

    toast("Account created successfully!","success");
    setTimeout(()=>location.href="dashboard.html",1200);

  } catch(err){
    console.error("Signup error:", err);
    toast("Sign up failed: " + (err.message || "Unknown"));
  }
});
</script>
</body>
</html>
